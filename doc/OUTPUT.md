# Output Formats

Guide to sample file organization, naming conventions, and SFZ file generation in AutosamplerT.

## Overview

AutosamplerT generates multi-sample libraries with:
- Organized directory structure
- Descriptive file naming
- SFZ mapping files
- Patch normalization
- Round-robin configuration

## What It's Used For

- **Sampler integration**: Direct import into samplers (Kontakt, SFZ players, etc.)
- **File organization**: Clear, predictable structure
- **Sample identification**: Descriptive filenames
- **Playback mapping**: Automatic key/velocity range assignment
- **Round-robin playback**: Automatic alternation setup

## Directory Structure

### Output Organization

```
output/
  <multisample_name>/
    <multisample_name>.sfz
    samples/
      <multisample_name>_<note>_v<velocity>_rr<layer>.wav
      <multisample_name>_<note>_v<velocity>_rr<layer>.wav
      ...
```

### Example

```
output/
  MySynth_Pad/
    MySynth_Pad.sfz
    samples/
      MySynth_Pad_C2_v40_rr1.wav
      MySynth_Pad_C2_v40_rr2.wav
      MySynth_Pad_C2_v80_rr1.wav
      MySynth_Pad_C2_v80_rr2.wav
      MySynth_Pad_E2_v40_rr1.wav
      ...
```

### Directory Structure Benefits

- **Clear hierarchy**: Easy to navigate
- **Self-contained**: Each multisample in own folder
- **Relative paths**: SFZ uses relative paths to samples
- **Portable**: Move entire folder without breaking links

## File Naming Convention

### Format

```
<multisample_name>_<note>_v<velocity>_rr<layer>.wav
```

### Components

| Component | Description | Example |
|-----------|-------------|---------|
| `multisample_name` | From YAML config | `MySynth_Pad` |
| `note` | Note name with octave | `C2`, `A#3`, `F#4` |
| `v<velocity>` | MIDI velocity value | `v40`, `v100`, `v127` |
| `rr<layer>` | Round-robin layer number | `rr1`, `rr2`, `rr3` |

### Examples

```
MySynth_Pad_C4_v100_rr1.wav
  - Multisample: MySynth_Pad
  - Note: C4 (middle C)
  - Velocity: 100
  - Round-robin: Layer 1

Prophet_Strings_A#3_v80_rr2.wav
  - Multisample: Prophet_Strings
  - Note: A#3 (A sharp, octave 3)
  - Velocity: 80
  - Round-robin: Layer 2

DrumKit_808_C2_v127_rr4.wav
  - Multisample: DrumKit_808
  - Note: C2 (kick drum)
  - Velocity: 127 (maximum)
  - Round-robin: Layer 4
```

### Note Naming

AutosamplerT uses standard note names:

- **Natural notes**: `C`, `D`, `E`, `F`, `G`, `A`, `B`
- **Sharps**: `C#`, `D#`, `F#`, `G#`, `A#`
- **Octave numbers**: `-1` to `9`

**Examples:**
- MIDI 21 → `A0`
- MIDI 60 → `C4` (middle C)
- MIDI 69 → `A4` (440Hz)
- MIDI 127 → `G9`

## SFZ File Format

### What is SFZ?

SFZ is an open file format for defining how audio samples are mapped to a sampler. It's human-readable and widely supported.

**Supported samplers:**
- sforzando (free)
- Plogue sforzando
- LinuxSampler
- Renoise
- Many DAW samplers

### Basic Structure

```sfz
<group>
lokey=c2 hikey=e2
lovel=0 hivel=59
seq_length=4
seq_position=1

<region>
sample=samples/MySynth_Pad_C2_v40_rr1.wav
pitch_keycenter=c2
lokey=c2 hikey=e2
lovel=0 hivel=59
seq_length=4
seq_position=1
```

### Key Elements

| Element | Description |
|---------|-------------|
| `<group>` | Defines common properties for multiple regions |
| `<region>` | Defines individual sample mapping |
| `sample` | Path to audio file (relative) |
| `pitch_keycenter` | Root pitch of sample |
| `lokey` / `hikey` | Key range for this sample |
| `lovel` / `hivel` | Velocity range for this sample |
| `seq_length` | Number of round-robin layers |
| `seq_position` | Current round-robin layer (1-based) |

### AutosamplerT Generated SFZ

AutosamplerT automatically generates optimized SFZ files with:

1. **Key range mapping**: Samples cover appropriate key ranges
2. **Velocity layering**: Automatic velocity split points
3. **Round-robin setup**: Configured alternation
4. **Relative paths**: Portable between systems
5. **Patch normalization**: Consistent levels across samples

### Example Generated SFZ

```sfz
// MySynth_Pad.sfz
// Generated by AutosamplerT
// 16 notes, 3 velocity layers, 4 round-robin layers
// Total samples: 192

// Velocity Layer 1: v40 (lovel=0, hivel=59)
<group>
lovel=0 hivel=59
seq_length=4

<region>
sample=samples/MySynth_Pad_C2_v40_rr1.wav
pitch_keycenter=c2
lokey=c2 hikey=d#2
seq_position=1

<region>
sample=samples/MySynth_Pad_C2_v40_rr2.wav
pitch_keycenter=c2
lokey=c2 hikey=d#2
seq_position=2

<region>
sample=samples/MySynth_Pad_C2_v40_rr3.wav
pitch_keycenter=c2
lokey=c2 hikey=d#2
seq_position=3

<region>
sample=samples/MySynth_Pad_C2_v40_rr4.wav
pitch_keycenter=c2
lokey=c2 hikey=d#2
seq_position=4

// ... more regions ...

// Velocity Layer 2: v80 (lovel=60, hivel=99)
<group>
lovel=60 hivel=99
seq_length=4

<region>
sample=samples/MySynth_Pad_C2_v80_rr1.wav
pitch_keycenter=c2
lokey=c2 hikey=d#2
seq_position=1

// ... etc ...
```

## Key Range Mapping

### Automatic Key Range

AutosamplerT automatically calculates optimal key ranges based on `noteInterval`.

**Example with `noteInterval: 4`:**
```
Sample C2  → covers C2 to D#2  (lokey=c2 hikey=d#2)
Sample E2  → covers E2 to G2   (lokey=e2 hikey=g2)
Sample G#2 → covers G#2 to B2  (lokey=g#2 hikey=b2)
Sample C3  → covers C3 to D#3  (lokey=c3 hikey=d#3)
```

**Formula:**
```
hikey = lokey + (noteInterval - 1)
```

### Edge Cases

- **First sample**: `lokey` may extend below sampled note
- **Last sample**: `hikey` may extend above sampled note
- **Single note**: `lokey == hikey == pitch_keycenter`

## Velocity Mapping

### Automatic Velocity Ranges

AutosamplerT calculates velocity ranges to ensure smooth transitions.

**Example with 3 velocity layers:**
```yaml
velocities: [40, 80, 120]
```

**Generated ranges:**
```
Layer 1 (v40):  lovel=0   hivel=59   (0-59)
Layer 2 (v80):  lovel=60  hivel=99   (60-99)
Layer 3 (v120): lovel=100 hivel=127  (100-127)
```

**Formula:**
```
lovel = (previous_velocity + current_velocity) / 2
hivel = (current_velocity + next_velocity) / 2
```

### Single Velocity

```yaml
velocities: [100]
```

**Generated range:**
```
Layer 1 (v100): lovel=0 hivel=127  (full range)
```

## Round-Robin Configuration

### SFZ Round-Robin Setup

```sfz
<group>
seq_length=4    // Total RR layers

<region>
sample=samples/MySynth_Pad_C2_v100_rr1.wav
seq_position=1  // Layer 1

<region>
sample=samples/MySynth_Pad_C2_v100_rr2.wav
seq_position=2  // Layer 2

<region>
sample=samples/MySynth_Pad_C2_v100_rr3.wav
seq_position=3  // Layer 3

<region>
sample=samples/MySynth_Pad_C2_v100_rr4.wav
seq_position=4  // Layer 4
```

### How RR Works

1. Player keeps track of `seq_position`
2. Each note trigger advances to next position
3. When reaching `seq_length`, wraps to position 1
4. Each note plays different sample automatically

### Benefits

- **Natural variation**: Each note sounds slightly different
- **Realism**: Mimics real instrument behavior
- **Automatic**: No programming needed in DAW

## Patch Normalization

### What It Does

AutosamplerT can normalize volume levels across all samples in a patch.

### Why It's Important

- **Consistent levels**: All samples at similar volume
- **Better velocity response**: Smooth dynamic curve
- **Professional quality**: No surprising volume jumps

### How It Works

1. **Find maximum**: Scan all samples for peak level
2. **Calculate gain**: Determine gain to reach target level
3. **Apply uniformly**: Apply same gain to all samples
4. **Preserve dynamics**: Relative volumes maintained

### Configuration

```python
# In src/sampler.py
normalize_patch = True       # Enable normalization
target_level_db = -3.0       # Target peak level (-3dB)
```

### Example

**Before normalization:**
```
C2_v40_rr1.wav:  Peak = -12dB
C2_v80_rr1.wav:  Peak = -6dB
C2_v120_rr1.wav: Peak = -3dB
```

**After normalization (target = -3dB):**
```
C2_v40_rr1.wav:  Peak = -3dB  (gain = +9dB)
C2_v80_rr1.wav:  Peak = -3dB  (gain = +3dB)
C2_v120_rr1.wav: Peak = -3dB  (gain = 0dB)
```

**Result:** All samples peak at -3dB, maintaining relative dynamics.

## Audio File Specifications

### Format

- **Container**: WAV
- **Codec**: PCM (uncompressed)
- **Endianness**: Little-endian

### Sample Rate

Matches audio interface configuration:
- **44100 Hz** (CD quality)
- **48000 Hz** (standard professional)

### Bit Depth

Matches audio interface configuration:
- **16-bit**: 96dB dynamic range
- **24-bit**: 144dB dynamic range

### Channels

- **Stereo**: 2 channels (most common)
- **Mono**: 1 channel (optional)

## Examples

### Example 1: Simple Patch

**Configuration:**
```yaml
multisample_name: "SimplePad"
sampling:
  startNote: 48
  endNote: 72
  noteInterval: 12
  velocities: [100]
  rr_layers: 1
```

**Output:**
```
output/SimplePad/
  SimplePad.sfz
  samples/
    SimplePad_C3_v100_rr1.wav
    SimplePad_C4_v100_rr1.wav
    SimplePad_C5_v100_rr1.wav
```

**SFZ:**
```sfz
<region>
sample=samples/SimplePad_C3_v100_rr1.wav
pitch_keycenter=c3
lokey=c3 hikey=b3
lovel=0 hivel=127

<region>
sample=samples/SimplePad_C4_v100_rr1.wav
pitch_keycenter=c4
lokey=c4 hikey=b4
lovel=0 hivel=127

<region>
sample=samples/SimplePad_C5_v100_rr1.wav
pitch_keycenter=c5
lokey=c5 hikey=c5
lovel=0 hivel=127
```

### Example 2: Multi-Layer Patch

**Configuration:**
```yaml
multisample_name: "LayeredPiano"
sampling:
  startNote: 21
  endNote: 108
  noteInterval: 3
  velocities: [40, 80, 120]
  rr_layers: 2
```

**Output:**
```
output/LayeredPiano/
  LayeredPiano.sfz
  samples/
    LayeredPiano_A0_v40_rr1.wav
    LayeredPiano_A0_v40_rr2.wav
    LayeredPiano_A0_v80_rr1.wav
    LayeredPiano_A0_v80_rr2.wav
    LayeredPiano_A0_v120_rr1.wav
    LayeredPiano_A0_v120_rr2.wav
    LayeredPiano_C1_v40_rr1.wav
    ... (540 files total)
```

## Best Practices

### 1. Descriptive Names
```yaml
# Good
multisample_name: "Moog_Bass_FilterOpen"

# Bad
multisample_name: "mb1"
```

### 2. Consistent Organization
Keep all projects in `output/` directory:
```
output/
  Project_A/
  Project_B/
  Tests/
```

### 3. Backup Strategy
- SFZ files are small (backup easily)
- WAV files are large (compress or archive)
- Keep original recordings

### 4. Version Control
Include version in name:
```yaml
multisample_name: "MySynth_Pad_v2"
```

### 5. Documentation
Add comments to SFZ files:
```sfz
// MySynth_Pad.sfz
// Source: Moog Subsequent 37
// Date: 2025-11-11
// Settings: Filter=70, Resonance=40
```

## Importing to Samplers

### sforzando (Free)

1. Open sforzando
2. Drag SFZ file to window
3. Play!

### Kontakt

1. Create new instrument
2. Use Kontakt's SFZ import
3. Map to zones

### Renoise

1. Open sampler
2. Import SFZ
3. Automatic mapping

### FL Studio

1. Use DirectWave
2. Import SFZ
3. Automatic key/velocity mapping

## Troubleshooting

### Samples Not Found
**Problem:** SFZ can't find WAV files

**Solutions:**
- Verify relative paths in SFZ
- Don't move sample files
- Keep folder structure intact

### Wrong Velocity Mapping
**Problem:** Velocity layers trigger incorrectly

**Solutions:**
- Check `lovel`/`hivel` ranges in SFZ
- Verify no gaps in velocity ranges
- Test with MIDI monitor

### No Round-Robin
**Problem:** Same sample plays every time

**Solutions:**
- Check `seq_length` matches RR layers
- Verify `seq_position` is unique per layer
- Ensure sampler supports round-robin

### Pitch Issues
**Problem:** Samples play at wrong pitch

**Solutions:**
- Verify `pitch_keycenter` matches sample root
- Check `lokey`/`hikey` ranges
- Ensure sample rate is consistent

## Related Documentation

- [Sampling Engine](SAMPLING.md) - Recording parameters
- [Post-Processing](POSTPROCESSING.md) - Normalization details
- [Scripting System](SCRIPTING.md) - Configuration

---

*Last updated: November 11, 2025*
